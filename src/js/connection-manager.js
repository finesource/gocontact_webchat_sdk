const connectionManager=function(){const e={main:[],voice:[],chat:[],tickets:[],webchat:[],webchat_plugin:[],internal:[]},t="POLLING",n="SSE",r="EXTERNAL",i="INTERNAL",a="HEARTBEAT",o={DUPLICATED_SESSION:"DUPLICATED_SESSION",INVALID_CONNECTION_MODE:"INVALID_CONNECTION_MODE",REQUEST_ERROR:"REQUEST_ERROR"};let s,u,l=null,d=!1;const c={errorCount:0,currentRequest:null},h={evtSource:null,heartbeatTimer:null,heartbeatInterval:45e3,firstStartDone:!1,errorCount:0,heartbeatCount:0,seqCount:0};async function f(){const e=c.errorCount;if(!1!==d&&null===c.currentRequest)try{const t=e>0;c.currentRequest=function(e,t){const{baseurl:n,serviceName:r}=s;let i={browserDate:(new Date).toISOString()};!0===e&&(i.fast="true");return $.ajax({dataType:"json",method:"GET",timeout:35e3,data:i,url:`${n}/${r}/message/${t}/consume`,xhrFields:{withCredentials:!0}})}(t,l);const n=await c.currentRequest;if(c.errorCount=0,!n||"object"!=typeof n||!1===n.hasOwnProperty("payloadType"))return;await y(n)}catch(e){c.errorCount++}finally{c.currentRequest=null;const t=c.errorCount;t>0?setTimeout(f,2e3):f(),t!==e&&t<2&&v({connectionError:1===t})}}function p(e){const{baseurl:t,serviceName:n}=s,r=new URLSearchParams({requestDate:(new Date).toISOString(),releaseMode:h.errorCount>5,seqCount:++h.seqCount}).toString();h.evtSource=new EventSource(`${t}/${n}/message/${e}/session?${r}`,{withCredentials:!0}),h.evtSource.onopen=function(e){h.errorCount=0,_(),v({connectionError:!1}),!1===h.firstStartDone&&(h.firstStartDone=!0,v({managerStarted:!0}))},h.evtSource.onerror=function(e){if(!1===d)return m();h.errorCount++,v({connectionError:!0}),m(!0)},h.evtSource.onmessage=function(e){y(JSON.parse(e.data))}}function m(e=!1){clearTimeout(h.heartbeatTimer),h.evtSource.close(),!1!==d&&!1!==e&&setTimeout(()=>p(l),2e3)}function _(){clearTimeout(h.heartbeatTimer),h.heartbeatTimer=setTimeout(()=>m(!0),h.heartbeatInterval)}function g(){h.heartbeatCount++,!1===d||h.heartbeatCount<4||(h.heartbeatCount=0,async function(e){const{baseurl:t,serviceName:n}=s,r=new URLSearchParams({requestDate:(new Date).toISOString()}).toString();await fetch(`${t}/${n}/key/${e}/check?${r}`)}(l))}function v(t){for(let n of e.internal)n.callback(t)}function y(t){const{payloadType:n,payloadBuildDate:o,payloadConsumeDate:s,data:u}=t;if(!1!==d){if(n===r)return function(t,n){for(let r of e[t.owner])r.callback(t.message,n)}({owner:u.messageOwner,message:u.message},t);if(n===a)return _(),void g();if(n===i&&!0===u.internalClose){if(u.connectionKey&&u.connectionKey!==l)return;if(!0===u.shouldReconnect)return;return v({replacedByServer:!0}),void(d=!1)}}}return window.addEventListener("offline",(function(){null!==c.currentRequest&&c.currentRequest.abort(),null!==h.evtSource&&m(!0)})),{start:async function(e,r,i,a=!1){s=e,u=r;const c=parseInt(i)||0;if(u===t||u===n)try{const e=await async function(e,t,n){const{baseurl:r,serviceName:i}=s,a=await fetch(`${r}/${i}/key`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({keepAlive:e,connectionMode:t,takeOwnership:n})});if(!a.ok){let e=new Error(o.REQUEST_ERROR);throw e.status=a.status,e}return a.json()}(c,u,a);if(l=e.connectionKey,d=!0,u===t)return v({managerStarted:!0}),void f();if(u===n)return void p(l)}catch(e){let t=e&&e.message||"UNHANDLED";423===e.status&&(t=o.DUPLICATED_SESSION),v({managerStarted:!1,errorCode:t})}else v({managerStarted:!1,errorCode:o.INVALID_CONNECTION_MODE})},close:async function(e=!1){if(null!==l){d=!1;try{await async function(e,t){const{baseurl:n,serviceName:r}=s,i=await fetch(`${n}/${r}/key/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({delayLogout:t})});if(!i.ok)throw new Error(o.REQUEST_ERROR);return i.json()}(l,e)}catch(e){}l=null,u===n&&(h.firstStartDone=!1,m())}},on:function(t,n,r){for(let r of e[n])if(r.subscriptionName===t)throw new Error("Duplicated subscription name: "+t);e[n].push({subscriptionName:t,callback:r})},off:function(t,n){e[n]=e[n].filter((function(e){return e.subscriptionName!==t}))},ERRORS:o}}();
